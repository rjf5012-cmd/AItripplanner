<script>
  // Year in footer
  document.getElementById("yearSpan").textContent = new Date().getFullYear();

  const form = document.getElementById("tripForm");
  const generateBtn = document.getElementById("generateBtn");
  const spinner = document.getElementById("spinner");
  const btnText = document.getElementById("btnText");
  const statusText = document.getElementById("statusText");
  const suggestionsContainer = document.getElementById("suggestionsContainer");
  const emptyState = document.getElementById("emptyState");
  const metaSummary = document.getElementById("metaSummary");

  function setLoading(isLoading, msg) {
    if (isLoading) {
      generateBtn.disabled = true;
      spinner.style.display = "inline-block";
      btnText.textContent = "Generating...";
      statusText.innerHTML = msg || "<strong>Thinking...</strong> Asking AI for ideas.";
    } else {
      generateBtn.disabled = false;
      spinner.style.display = "none";
      btnText.textContent = "Generate trip ideas";
      statusText.innerHTML =
        msg || "Powered by AI. Usually just a few seconds.";
    }
  }

  function renderSuggestions(suggestions) {
    suggestionsContainer.innerHTML = "";

    if (!suggestions || suggestions.length === 0) {
      suggestionsContainer.appendChild(emptyState);
      emptyState.style.display = "block";
      metaSummary.textContent = "No results. Try different details.";
      return;
    }

    emptyState.style.display = "none";

    suggestions.forEach((s, idx) => {
      const card = document.createElement("article");
      card.className = "suggestion-card";

      const topRow = document.createElement("div");
      topRow.className = "suggestion-top-row";

      const title = document.createElement("div");
      title.className = "suggestion-title";
      title.textContent = s.title || "Activity " + (idx + 1);

      const chips = document.createElement("div");
      chips.className = "chip-row";

      const todChip = document.createElement("span");
      todChip.className = "chip accent";

      const tod = (s.timeOfDay || "flex").toLowerCase();
      todChip.textContent =
        tod === "morning"
          ? "Morning"
          : tod === "afternoon"
          ? "Afternoon"
          : tod === "evening"
          ? "Evening"
          : "Flexible";

      chips.appendChild(todChip);

      if (typeof s.dayHint === "number") {
        const dayChip = document.createElement("span");
        dayChip.className = "chip";
        dayChip.textContent = "Day " + s.dayHint;
        chips.appendChild(dayChip);
      }

      topRow.appendChild(title);
      topRow.appendChild(chips);

      const desc = document.createElement("p");
      desc.className = "suggestion-desc";
      desc.textContent = s.description || "";

      const notes = document.createElement("p");
      notes.className = "suggestion-notes";
      notes.textContent = s.notes || "";

      card.appendChild(topRow);
      card.appendChild(desc);
      card.appendChild(notes);

      suggestionsContainer.appendChild(card);
    });

    metaSummary.textContent = suggestions.length + " ideas generated.";
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const destination = document.getElementById("destination").value.trim();
    const days = document.getElementById("days").value.trim();
    const start = document.getElementById("start").value.trim();
    const travelers = document.getElementById("travelers").value.trim();
    const vibe = document.getElementById("vibe").value.trim();
    const prefs = document.getElementById("prefs").value.trim();

    if (!destination) {
      statusText.innerHTML =
        "<span class='status-error'>Please enter a destination first.</span>";
      return;
    }

    const promptParts = [];
    promptParts.push("Destination: " + destination);
    if (days) promptParts.push("Trip length: " + days + " days");
    if (start) promptParts.push("Start date: " + start);
    if (travelers) promptParts.push("Travelers: " + travelers);
    if (vibe) promptParts.push("Vibe: " + vibe);
    if (prefs) promptParts.push("Preferences: " + prefs);

    const finalPrompt =
      "Generate trip activity ideas as JSON. " +
      promptParts.join(". ") +
      ". Respond as: { \"suggestions\": [...] }";

    setLoading(true);

    try {
      const res = await fetch("/api/generate-itinerary", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: finalPrompt })
      });

      const text = await res.text();
      console.log("Raw API response:", text);

      let data;
      try {
        data = JSON.parse(text);
      } catch (err) {
        console.error("JSON parse error:", err);
        setLoading(false, "<span class='status-error'>Invalid server JSON.</span>");
        return;
      }

      if (data.error) {
        console.error("API Error:", data);
        setLoading(false, "<span class='status-error'>" + data.error + "</span>");
        return;
      }

      renderSuggestions(data.suggestions || []);
      setLoading(false, "<strong>Done.</strong> Ideas loaded.");
    } catch (err) {
      console.error("Network error:", err);
      setLoading(false, "<span class='status-error'>Network error.</span>");
    }
  });
</script>
