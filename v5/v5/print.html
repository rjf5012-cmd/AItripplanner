<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Print Itinerary | AITripPlan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <!-- Font (Inter) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --text-main: #0f172a;
      --text-soft: #4b5563;
      --text-muted: #6b7280;
      --border-subtle: #e5e7eb;
      --accent: #2563eb;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: white;
    }

    .page {
      max-width: 800px;
      margin: 16px auto 32px;
      padding: 0 16px;
    }

    header.print-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 8px;
      margin-bottom: 12px;
    }

    .print-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.03em;
    }

    .print-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .trip-meta {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 16px;
    }

    .trip-meta span {
      display: inline-block;
      margin-right: 12px;
    }

    h2.section-heading {
      font-size: 16px;
      margin-top: 18px;
      margin-bottom: 6px;
    }

    h3.day-heading {
      font-size: 14px;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .day-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    ul.itinerary-list {
      list-style: none;
      padding-left: 0;
      margin: 0 0 6px;
      font-size: 12px;
    }

    ul.itinerary-list li {
      margin-bottom: 4px;
    }

    .time-label {
      font-weight: 600;
      text-transform: capitalize;
      margin-right: 4px;
    }

    .item-notes {
      font-size: 11px;
      color: var(--text-muted);
    }

    .divider {
      border-top: 1px solid var(--border-subtle);
      margin: 14px 0;
    }

    ul.simple-list {
      padding-left: 18px;
      margin-top: 4px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    ul.simple-list li {
      margin-bottom: 3px;
    }

    .print-controls {
      text-align: right;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .print-controls button {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 11px;
    }

    .print-controls button:hover {
      background: #eef2ff;
    }

    @media print {
      .print-controls {
        display: none;
      }
      .page {
        margin: 0 auto;
        padding: 0 10mm;
      }
      header.print-header {
        margin-top: 4mm;
      }
      .divider {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="print-controls">
      <button type="button" onclick="window.print()">Print / Save as PDF</button>
    </div>

    <header class="print-header">
      <div>
        <div class="print-title" id="printTitle">Trip Itinerary</div>
        <div class="print-subtitle">
          Generated with AITripPlan.com
        </div>
      </div>
      <div class="print-subtitle" id="exportStamp"></div>
    </header>

    <section id="tripMeta" class="trip-meta">
      <!-- Filled by JS -->
    </section>

    <section id="itinerarySection">
      <h2 class="section-heading">Day-by-day itinerary</h2>
      <div id="itineraryContent"></div>
    </section>

    <div class="divider"></div>

    <section id="mapsSection">
      <h2 class="section-heading">Maps &amp; locations</h2>
      <p style="font-size:12px; margin:0 0 4px;">
        Use these links to quickly open search results in Google Maps.
      </p>
      <ul class="simple-list" id="mapsList"></ul>
    </section>

    <div class="divider"></div>

    <section id="restaurantsSection">
      <h2 class="section-heading">Restaurant &amp; food ideas</h2>
      <p style="font-size:12px; margin:0 0 4px;">
        Highlighted spots that look food-focused, based on your itinerary.
      </p>
      <ul class="simple-list" id="restaurantsList"></ul>
    </section>

    <div class="divider"></div>

    <section id="packingSection">
      <h2 class="section-heading">Packing list (starter)</h2>
      <p style="font-size:12px; margin:0 0 4px;">
        Start here and customize based on your destination and season.
      </p>
      <ul class="simple-list" id="packingList">
        <li>Comfortable walking shoes</li>
        <li>Weather-appropriate outerwear (light jacket / raincoat)</li>
        <li>Daypack or small backpack</li>
        <li>Travel documents (ID/passport, confirmations, tickets)</li>
        <li>Chargers, power adapters, and battery pack</li>
        <li>Reusable water bottle</li>
        <li>Any necessary medications</li>
        <li>Swimwear and beach gear (if applicable)</li>
        <li>One nicer outfit for dinners or shows</li>
      </ul>
    </section>

    <div class="divider"></div>

    <section id="weatherSection">
      <h2 class="section-heading">Weather snapshot (check before you go)</h2>
      <p style="font-size:12px; margin:0 0 4px;">
        For the latest forecast, check a few days before departure:
      </p>
      <ul class="simple-list">
        <li>Search “<span id="weatherSearchLabel"></span> 10 day forecast”</li>
        <li>Use weather apps (Weather.com, local meteorological service, etc.)</li>
        <li>Adjust layers, rain gear, and footwear based on the forecast.</li>
      </ul>
    </section>
  </div>

  <script>
    function groupSuggestions(suggestions) {
      const dayBuckets = new Map();
      const flex = [];

      suggestions.forEach((s) => {
        const day =
          typeof s.dayHint === "number" && isFinite(s.dayHint)
            ? s.dayHint
            : null;
        if (day === null) {
          flex.push(s);
        } else {
          if (!dayBuckets.has(day)) dayBuckets.set(day, []);
          dayBuckets.get(day).push(s);
        }
      });

      const dayNumbers = Array.from(dayBuckets.keys()).sort((a, b) => a - b);
      const timeWeights = { morning: 0, afternoon: 1, evening: 2, flex: 3 };

      function sortByTime(list) {
        return list.slice().sort((a, b) => {
          const ta = (a.timeOfDay || "flex").toString().toLowerCase();
          const tb = (b.timeOfDay || "flex").toString().toLowerCase();
          const wa = Object.prototype.hasOwnProperty.call(timeWeights, ta)
            ? timeWeights[ta]
            : 4;
          const wb = Object.prototype.hasOwnProperty.call(timeWeights, tb)
            ? timeWeights[tb]
            : 4;
          if (wa !== wb) return wa - wb;
          return (a.title || "").localeCompare(b.title || "");
        });
      }

      return {
        days: dayNumbers.map((d) => ({
          dayNumber: d,
          items: sortByTime(dayBuckets.get(d) || []),
        })),
        flex: sortByTime(flex),
      };
    }

    function buildItineraryView(container, groups) {
      container.innerHTML = "";

      if ((!groups.days.length) && (!groups.flex.length)) {
        container.innerHTML =
          "<p style='font-size:12px; color:#6b7280;'>No items found in this itinerary.</p>";
        return;
      }

      groups.days.forEach((dayObj) => {
        const dayWrap = document.createElement("section");
        const h = document.createElement("h3");
        h.className = "day-heading";
        h.textContent = "Day " + dayObj.dayNumber;
        const sub = document.createElement("div");
        sub.className = "day-sub";
        sub.textContent = "Morning, afternoon and evening ideas.";

        const list = document.createElement("ul");
        list.className = "itinerary-list";

        dayObj.items.forEach((item) => {
          const li = document.createElement("li");
          const time = (item.timeOfDay || "flex").toString().toLowerCase();
          const timeLabel =
            time === "flex" ? "Any time" : time.charAt(0).toUpperCase() + time.slice(1);
          const strong = document.createElement("span");
          strong.className = "time-label";
          strong.textContent = timeLabel + ":";

          const textSpan = document.createElement("span");
          const title = item.title || "Activity";
          const desc = item.description || "";
          textSpan.textContent = " " + title + (desc ? " — " + desc : "");

          li.appendChild(strong);
          li.appendChild(textSpan);

          if (item.neighborhood || item.travelTime) {
            const meta = document.createElement("div");
            meta.className = "item-notes";
            const bits = [];
            if (item.neighborhood) bits.push(item.neighborhood);
            if (item.travelTime) bits.push(item.travelTime);
            meta.textContent = bits.join(" · ");
            li.appendChild(meta);
          }

          if (item.notes) {
            const notes = document.createElement("div");
            notes.className = "item-notes";
            notes.textContent = item.notes;
            li.appendChild(notes);
          }

          list.appendChild(li);
        });

        dayWrap.appendChild(h);
        dayWrap.appendChild(sub);
        dayWrap.appendChild(list);
        container.appendChild(dayWrap);
      });

      if (groups.flex.length) {
        const dayWrap = document.createElement("section");
        const h = document.createElement("h3");
        h.className = "day-heading";
        h.textContent = "Any day ideas";
        const sub = document.createElement("div");
        sub.className = "day-sub";
        sub.textContent = "Flexible activities you can plug into any day.";

        const list = document.createElement("ul");
        list.className = "itinerary-list";

        groups.flex.forEach((item) => {
          const li = document.createElement("li");
          const strong = document.createElement("span");
          strong.className = "time-label";
          strong.textContent = "Any time:";

          const textSpan = document.createElement("span");
          const title = item.title || "Activity";
          const desc = item.description || "";
          textSpan.textContent = " " + title + (desc ? " — " + desc : "");

          li.appendChild(strong);
          li.appendChild(textSpan);

          if (item.neighborhood || item.travelTime) {
            const meta = document.createElement("div");
            meta.className = "item-notes";
            const bits = [];
            if (item.neighborhood) bits.push(item.neighborhood);
            if (item.travelTime) bits.push(item.travelTime);
            meta.textContent = bits.join(" · ");
            li.appendChild(meta);
          }

          if (item.notes) {
            const notes = document.createElement("div");
            notes.className = "item-notes";
            notes.textContent = item.notes;
            li.appendChild(notes);
          }

          list.appendChild(li);
        });

        dayWrap.appendChild(h);
        dayWrap.appendChild(sub);
        dayWrap.appendChild(list);
        container.appendChild(dayWrap);
      }
    }

    function buildMapsList(container, meta, suggestions) {
      container.innerHTML = "";
      const used = new Set();
      const items = [];

      suggestions.forEach((s) => {
        let query = null;
        if (s.mapsSearch && typeof s.mapsSearch === "string") {
          query = s.mapsSearch.trim();
        } else if (s.title) {
          query = s.title;
        }
        if (!query) return;
        const key = query.toLowerCase();
        if (used.has(key)) return;
        used.add(key);

        const url =
          "https://www.google.com/maps/search/?api=1&query=" +
          encodeURIComponent(query);
        items.push({ label: query, url });
      });

      if (!items.length) {
        container.innerHTML =
          "<li>No specific locations were tagged. Use the activity names above as search terms in Google Maps.</li>";
        return;
      }

      items.forEach((item) => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = item.url;
        a.textContent = item.label;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        li.appendChild(a);
        container.appendChild(li);
      });
    }

    function buildRestaurantsList(container, suggestions) {
      container.innerHTML = "";
      const used = new Set();
      const items = [];
      const foodKeywords = [
        "restaurant","dinner","lunch","breakfast","brunch",
        "cafe","bar","bistro","tapas","wine","cocktail"
      ];

      function looksFoodRelated(s) {
        const text =
          (s.title || "") + " " + (s.description || "") + " " + (s.notes || "");
        const lower = text.toLowerCase();
        return foodKeywords.some((kw) => lower.includes(kw));
      }

      suggestions.forEach((s) => {
        if (!looksFoodRelated(s)) return;
        const name = s.title || "Food / drink stop";
        const key = name.toLowerCase();
        if (used.has(key)) return;
        used.add(key);
        items.push(name);
      });

      if (!items.length) {
        container.innerHTML =
          "<li>No obviously food-focused stops were detected. Use your itinerary above to choose where to eat.</li>";
        return;
      }

      items.forEach((name) => {
        const li = document.createElement("li");
        li.textContent = name;
        container.appendChild(li);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const raw = localStorage.getItem("aitripplan_latest_export");
      let payload = null;
      if (raw) {
        try {
          payload = JSON.parse(raw);
        } catch (e) {
          console.error("Failed to parse export payload:", e);
        }
      }

      if (!payload || !Array.isArray(payload.suggestions)) {
        document.getElementById("itineraryContent").innerHTML =
          "<p style='font-size:12px; color:#6b7280;'>No itinerary found. Go back to AITripPlan.com, generate a trip, and click Export again.</p>";
        return;
      }

      const meta = payload.meta || {};
      const suggestions = payload.suggestions || [];

      const titleEl = document.getElementById("printTitle");
      if (meta.destination) {
        titleEl.textContent = meta.destination + " — Trip Itinerary";
      }

      const exportStamp = document.getElementById("exportStamp");
      if (payload.exportedAt) {
        const d = new Date(payload.exportedAt);
        if (!isNaN(d.getTime())) {
          exportStamp.textContent =
            "Exported " + d.toLocaleDateString() + " " + d.toLocaleTimeString();
        }
      }

      const tripMetaEl = document.getElementById("tripMeta");
      const bits = [];
      if (meta.dates) bits.push("Dates: " + meta.dates);
      if (meta.daysNumber) bits.push("Trip length: " + meta.daysNumber + " day(s)");
      if (meta.travelers) bits.push("Who: " + meta.travelers);
      if (meta.budget) bits.push("Budget: " + meta.budget);
      if (meta.tripType) bits.push("Trip type: " + meta.tripType);
      if (meta.mustInclude && meta.mustInclude.length) {
        bits.push("Must include: " + meta.mustInclude.join(", "));
      }
      if (bits.length) {
        tripMetaEl.innerHTML = bits.map((b) => "<span>" + b + "</span>").join("");
      } else {
        tripMetaEl.innerHTML =
          "<span>No extra trip details were provided.</span>";
      }

      const weatherLabel = document.getElementById("weatherSearchLabel");
      if (weatherLabel) {
        const dest = meta.destination || "your destination city";
        weatherLabel.textContent = dest;
      }

      const groups = groupSuggestions(suggestions);
      buildItineraryView(
        document.getElementById("itineraryContent"),
        groups
      );
      buildMapsList(
        document.getElementById("mapsList"),
        meta,
        suggestions
      );
      buildRestaurantsList(
        document.getElementById("restaurantsList"),
        suggestions
      );

      // Automatically prompt print after a short delay
      setTimeout(() => {
        window.print();
      }, 600);
    });
  </script>
</body>
</html>
